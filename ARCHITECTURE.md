# Architecture & Amplify Backend Layout

This document is the **high-level architecture reference** for the two core backend flows:
- **Guess settlement** (one-shot schedule per guess)
- **Price snapshot ingestion + realtime fanout**

It also explains what exists under `amplify/` and why.

### Guess settlement (backend) — architecture diagram

```mermaid
flowchart TB
    subgraph frontend [Frontend]
        GuessAction[GuessAction Component]
        GuessHistory[GuessHistory Component]
    end

    subgraph bff [BFF_Nextjs_API_Routes]
        PostGuess[POST_/api/guess]
        GuessStream[GET_/api/guess/stream_SSE]
    end

    subgraph appsync [AppSync_GraphQL]
        CreateGuess[createGuess Mutation]
        UpdateGuess[updateGuess Mutation]
        OnUpdateGuess[onUpdateGuess Subscription]
        GuessesByOwner[guessesByOwner Query]
        PriceSnapshotsBySource[priceSnapshotsBySourceUpdatedAt Query]
    end

    subgraph dynamodb [DynamoDB]
        GuessTable[Guess Table]
        GuessStream_DDB[DynamoDB Stream]
        PriceSnapshotTable[PriceSnapshot Table]
        UserStateTable[UserState Table]
    end

    subgraph lambdas [Lambda Functions]
        ScheduleLambda[scheduleGuessLambda]
        SettleLambda[settleGuessLambda]
    end

    subgraph eventbridge [EventBridge Scheduler]
        GuessSchedule[One-time Schedule at settleAt]
    end

    GuessAction -->|"1_Create_guess"| PostGuess
    PostGuess -->|"2_Mutation"| CreateGuess
    CreateGuess -->|"3_Write"| GuessTable
    GuessTable -->|"4_Stream_INSERT"| GuessStream_DDB
    GuessStream_DDB -->|"5_Trigger"| ScheduleLambda
    ScheduleLambda -->|"6_Create_schedule"| GuessSchedule
    GuessSchedule -->|"7_At_settleAt"| SettleLambda
    SettleLambda -->|"8a_Query_prices"| PriceSnapshotsBySource
    SettleLambda -->|"8b_Update_guess"| UpdateGuess
    SettleLambda -->|"8c_Update_score"| UserStateTable
    UpdateGuess -->|"9_Publishes"| OnUpdateGuess
    OnUpdateGuess -->|"10_WS"| GuessStream
    GuessStream -->|"11_SSE"| GuessAction
    GuessStream -->|"11_SSE"| GuessHistory
    GuessesByOwner -->|"Query"| GuessTable
```

### Guess settlement — snapshot resolution rule

Settlement relies on `PriceSnapshot.sourceUpdatedAt` (CoinGecko’s timestamp) for determinism.

- For `createdAt`: pick the **latest** snapshot where `sourceUpdatedAt <= createdAt`
- For `settleAt`: pick the **latest** snapshot where `sourceUpdatedAt <= settleAt`

This is implemented in `amplify/backend/function/settleGuessLambda/src/index.js` by querying `priceSnapshotsBySourceUpdatedAt` with `sortDirection: DESC` and `sourceUpdatedAt: { le: <timestamp> }`, `limit: 1`.

---

### Price snapshot ingestion + realtime updates — architecture diagram

```mermaid
flowchart TB
    subgraph browser [Browser]
        PriceUI["Price UI"]
        SSEClient["EventSource (/api/price-snapshot/stream)"]
    end

    subgraph nextjs [Nextjs_BFF]
        SseRoute["GET /api/price-snapshot/stream (SSE)"]
        Relay["price-snapshot-relay"]
        UpstreamWS["AppSync Realtime WS (subscription)"]
    end

    subgraph stepfunctions [Step_Functions_Express]
        PriceSnapshotScheduler["priceSnapshotScheduler"]
    end

    subgraph lambdas [Lambda]
        PriceJob["priceSnapshotJob"]
    end

    subgraph external [External]
        CoinGecko["CoinGecko API"]
    end

    subgraph appsync [AppSync_GraphQL]
        CreateSnapshot["createPriceSnapshot (mutation)"]
        OnCreateSnapshot["onCreatePriceSnapshot (subscription)"]
    end

    subgraph dynamodb [DynamoDB]
        PriceSnapshotTable["PriceSnapshot Table"]
    end

    PriceSnapshotScheduler -->|"Invoke_on_interval"| PriceJob
    PriceJob -->|"Fetch_price"| CoinGecko
    PriceJob -->|"Write_snapshot"| CreateSnapshot
    CreateSnapshot -->|"Persist"| PriceSnapshotTable
    CreateSnapshot -->|"Publishes"| OnCreateSnapshot
    OnCreateSnapshot -->|"Upstream_sub"| UpstreamWS
    UpstreamWS -->|"Broadcast"| Relay
    Relay -->|"SSE"| SseRoute
    SseRoute -->|"SSE_stream"| SSEClient
    SSEClient -->|"Render_updates"| PriceUI
```

---

### Amplify backend setup — what exists and what it’s for

This project uses **Amplify Gen1** (CloudFormation-based). The backend lives under `amplify/backend/`.

- **`amplify/backend/api/epilot/`**: AppSync + DynamoDB (Amplify GraphQL transformer)
  - **`schema.graphql`**: source schema (`@model`, `@auth`, `@index`), including `Guess`, `PriceSnapshot`, `UserState`
  - **`transform.conf.json`**: transformer config; enables **DynamoDB Streams** for `Guess` (NEW_IMAGE) so `scheduleGuessLambda` can be triggered
  - **`build/schema.graphql`**: compiled schema output (generated by Amplify; source of truth for Codegen)

- **`amplify/backend/function/`**: Lambda functions
  - **`priceSnapshotJob/`**: fetches CoinGecko price and writes `PriceSnapshot` via AppSync (API key auth)
  - **`scheduleGuessLambda/`**: triggered by **Guess DynamoDB Stream INSERT**, creates **EventBridge Scheduler** one-shot schedule (idempotent by schedule name)
  - **`settleGuessLambda/`**: invoked by EventBridge Scheduler at `settleAt`, resolves snapshots, updates `Guess` (SETTLED/FAILED), updates `UserState.score`
  - **`epilotAuthPostConfirmation/`**: Cognito post-confirm trigger that creates `UserState` for a new user

- **`amplify/backend/custom/`**: custom CloudFormation stacks (Amplify “custom resources”)
  - **`priceSnapshotScheduler/`**: provisions the Step Functions scheduler used by `priceSnapshotJob`
  - **`guessSettlementScheduler/`**: provisions EventBridge Scheduler resources:
    - Schedule group `guess-settlements`
    - IAM role used by Scheduler to invoke `settleGuessLambda`

- **`amplify/backend/backend-config.json`**: Amplify’s wiring/metadata
  - Declares functions/custom stacks
  - Declares dependencies (`scheduleGuessLambda` depends on the settle lambda ARN + scheduler role ARN + GraphQL API id output to import the Guess table stream ARN)

- **Testing under Amplify**
  - **Unit tests**: `amplify/backend/function/*/src/__tests__/*.unit.test.js`
  - **AWS integration smoke tests**: `amplify/backend/__tests__/integration/*.int.test.ts` (real AWS calls; validate wiring + permissions)

### Related docs

- **Developer bootstrap**: `SETUP.MD`
- **BFF + query + SSE relay pattern**: `FETCHING.md`
- **Test strategy + how to run integration tests**: `TESTING.md`

